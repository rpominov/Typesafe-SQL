// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("rescript/lib/js/curry.js");
var Caml_array = require("rescript/lib/js/caml_array.js");
var TypesafeSQLDescribeQuery = require("@typesafe-sql/rescript-describe-query/lib/js/TypesafeSQLDescribeQuery.bs.js");
var Promise$TypesafeSqlBuilder = require("./Promise.bs.js");
var DescribeQuery = require("@typesafe-sql/describe-query");

function isValidIdentifierCh(ch) {
  var code = ch.charCodeAt(0);
  if (code >= 48 && code <= 57 || code >= 65 && code <= 90) {
    return true;
  } else if (code >= 97) {
    return code <= 122;
  } else {
    return false;
  }
}

function parseStatement(text) {
  var parameters = [];
  var commitParameter = function (newText, parameter, nextCh) {
    var index = parameters.push(parameter);
    return [
            newText + "$" + index.toString() + nextCh,
            undefined
          ];
  };
  var helper = function (_newText, _state, _pos, _parameter, _name) {
    while(true) {
      var name = _name;
      var parameter = _parameter;
      var pos = _pos;
      var state = _state;
      var newText = _newText;
      var nextCh = text.charAt(pos);
      var match = text.charAt(pos + 1 | 0);
      var state$p;
      if (nextCh === "") {
        state$p = undefined;
      } else {
        switch (state) {
          case /* Code */0 :
              switch (nextCh) {
                case "-" :
                    state$p = match === "-" ? /* InlineComment */1 : state;
                    break;
                case "/" :
                    state$p = match === "*" ? /* BlockComment */2 : state;
                    break;
                default:
                  state$p = state;
              }
              break;
          case /* InlineComment */1 :
              state$p = nextCh === "\n" ? /* Code */0 : state;
              break;
          case /* BlockComment */2 :
              state$p = nextCh === "*" && match === "/" ? /* Code */0 : state;
              break;
          
        }
      }
      var match$1;
      if (parameter !== undefined) {
        match$1 = state$p !== undefined && !(state$p !== 0 || !isValidIdentifierCh(nextCh)) ? [
            newText,
            parameter + nextCh
          ] : commitParameter(newText, parameter, nextCh);
      } else {
        var exit = 0;
        if (state$p !== undefined && !(state$p !== 0 || nextCh !== "$")) {
          match$1 = [
            newText,
            ""
          ];
        } else {
          exit = 1;
        }
        if (exit === 1) {
          match$1 = [
            newText + nextCh,
            undefined
          ];
        }
        
      }
      var newText$p = match$1[0];
      var name$p;
      if (typeof name === "number") {
        if (name === /* Looking */0) {
          var exit$1 = 0;
          if (state$p === 0) {
            name$p = /* NotFound */1;
          } else {
            exit$1 = 1;
          }
          if (exit$1 === 1) {
            name$p = nextCh === "@" ? ({
                  TAG: /* InProgress */0,
                  _0: ""
                }) : name;
          }
          
        } else {
          name$p = name;
        }
      } else if (name.TAG === /* InProgress */0) {
        var val = name._0;
        name$p = state$p !== undefined && state$p !== 0 && isValidIdentifierCh(nextCh) ? ({
              TAG: /* InProgress */0,
              _0: val + nextCh
            }) : ({
              TAG: /* Found */1,
              _0: val
            });
      } else {
        name$p = name;
      }
      if (state$p === undefined) {
        if (typeof name$p === "number") {
          return {
                  TAG: /* Error */1,
                  _0: "The following statement is missing a name declaration. Did you forget to add a \"-- @someName\" comment?\n\n" + text
                };
        } else if (name$p.TAG === /* Found */1) {
          return {
                  TAG: /* Ok */0,
                  _0: [
                    name$p._0,
                    newText$p
                  ]
                };
        } else {
          return {
                  TAG: /* Error */1,
                  _0: "The following statement is missing a name declaration. Did you forget to add a \"-- @someName\" comment?\n\n" + text
                };
        }
      }
      _name = name$p;
      _parameter = match$1[1];
      _pos = pos + 1 | 0;
      _state = state$p;
      _newText = newText$p;
      continue ;
    };
  };
  var message = helper("", /* Code */0, 0, undefined, /* Looking */0);
  if (message.TAG !== /* Ok */0) {
    return {
            TAG: /* Error */1,
            _0: message._0
          };
  }
  var match = message._0;
  return {
          TAG: /* Ok */0,
          _0: [
            match[0],
            parameters,
            match[1]
          ]
        };
}

function processFileContent(client, text, cb) {
  var statements = text.split(";").map(function (prim) {
          return prim.trim();
        }).filter(function (val) {
        return val !== "";
      });
  var helper = function (index, results) {
    if (index >= statements.length) {
      return Curry._1(cb, {
                  TAG: /* Ok */0,
                  _0: results
                });
    }
    var message = parseStatement(Caml_array.get(statements, index));
    if (message.TAG !== /* Ok */0) {
      return Curry._1(cb, {
                  TAG: /* Error */1,
                  _0: message._0
                });
    }
    var match = message._0;
    var text = match[2];
    var parameters = match[1];
    var name = match[0];
    return Promise$TypesafeSqlBuilder.subscribe(client.describe(text), (function (val) {
                  if (val.TAG === /* Ok */0) {
                    return helper(index + 1 | 0, results.concat([{
                                      name: name,
                                      parameters: parameters,
                                      text: text,
                                      description: val._0
                                    }]));
                  } else {
                    return Curry._1(cb, {
                                TAG: /* Error */1,
                                _0: "Database server could not process the following statement:\n\n" + text + "\n\n" + TypesafeSQLDescribeQuery.errorToString(val._0)
                              });
                  }
                }));
  };
  return helper(0, []);
}

var example = "\n  -- @allAnimals\n  SELECT * FROM animals;\n\n  -- @syntaxError\n  SELECT * FROMM animals;\n";

Promise$TypesafeSqlBuilder.subscribe(DescribeQuery.createClient({
          user: "testuser",
          password: "testpassword",
          host: "localhost",
          database: "testdatabase"
        }), (function (val) {
        if (val.TAG === /* Ok */0) {
          var client = val._0;
          return processFileContent(client, example, (function (results) {
                        if (results.TAG === /* Ok */0) {
                          console.log(results._0);
                        } else {
                          console.error(results._0);
                        }
                        client.terminate();
                        
                      }));
        }
        console.error(val._0);
        
      }));

var DescribeQuery$1;

exports.DescribeQuery = DescribeQuery$1;
exports.isValidIdentifierCh = isValidIdentifierCh;
exports.parseStatement = parseStatement;
exports.processFileContent = processFileContent;
exports.example = example;
/*  Not a pure module */
