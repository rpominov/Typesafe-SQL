// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var TTY = require("@typesafe-sql/rescript-common/lib/js/src/TTY.bs.js");
var Curry = require("rescript/lib/js/curry.js");
var $$Promise = require("@rpominov/rescript-promise/lib/js/Promise.bs.js");
var Process = require("process");
var LogError = require("@typesafe-sql/rescript-common/lib/js/src/LogError.bs.js");
var PathRebuild = require("rescript-path-rebuild/lib/js/PathRebuild.bs.js");
var Client$DescribeQuery = require("@typesafe-sql/rescript-describe-query/lib/js/Client.bs.js");
var Fs$TypesafeSqlBuilder = require("./Fs.bs.js");
var Steps$TypesafeSqlBuilder = require("./Steps.bs.js");

function make(pgConfig, rootDir, sources, output, generator) {
  return $$Promise.chainOk(Client$DescribeQuery.make(pgConfig, undefined), (function (describeQueryClient) {
                var fn = PathRebuild.make(output);
                var tmp;
                if (fn.TAG === /* Ok */0) {
                  var fn$1 = fn._0;
                  tmp = {
                    TAG: /* Ok */0,
                    _0: {
                      describeQueryClient: describeQueryClient,
                      rootDir: Fs$TypesafeSqlBuilder.resoloveRoot(rootDir),
                      sources: sources,
                      output: (function (x) {
                          return Curry._2(fn$1, undefined, x);
                        }),
                      generator: generator,
                      processingFiles: false,
                      terminated: false
                    }
                  };
                } else {
                  tmp = {
                    TAG: /* Error */1,
                    _0: LogError.wrapString(fn._0)
                  };
                }
                return $$Promise.resolve(tmp);
              }));
}

function terminate(client) {
  if (client.terminated) {
    console.warn("terminate() was applied to a client that is already terminated");
  } else {
    client.terminated = true;
    Client$DescribeQuery.terminate(client.describeQueryClient);
  }
  
}

function processFile(client, file) {
  Process.stdout.write("[" + file + "]");
  var message = Curry._1(client.output, file);
  if (message.TAG === /* Ok */0) {
    var output = message._0;
    return $$Promise.chain(TTY.progress($$Promise.chainOk(TTY.progress($$Promise.chainOk(TTY.progress($$Promise.chainOk(TTY.progress(Fs$TypesafeSqlBuilder.read(Fs$TypesafeSqlBuilder.joinPath(client.rootDir, file))), Steps$TypesafeSqlBuilder.Parse.asyncParse)), (function (parsed) {
                                  return $$Promise.chainOk(TTY.progress(Steps$TypesafeSqlBuilder.Describe.describeMany(client.describeQueryClient, parsed.map(function (x) {
                                                          return x.processedStatement;
                                                        }))), (function (__x) {
                                                return Steps$TypesafeSqlBuilder.Generate.generate(parsed, __x, client.generator);
                                              }));
                                }))), (function (__x) {
                          return Fs$TypesafeSqlBuilder.write(Fs$TypesafeSqlBuilder.joinPath(client.rootDir, output), __x);
                        }))), (function (result) {
                  if (result.TAG === /* Ok */0) {
                    Process.stdout.write("ok\n");
                  } else {
                    Process.stdout.write("error\n");
                    LogError.log(result._0);
                    console.error("");
                  }
                  return $$Promise.resolve(undefined);
                }));
  }
  console.error(message._0);
  return $$Promise.resolve(undefined);
}

function build(client) {
  return $$Promise.chain(Fs$TypesafeSqlBuilder.resolve(client.rootDir, client.sources), (function (result) {
                if (result.TAG === /* Ok */0) {
                  return $$Promise.chain($$Promise.sequence(result._0.map(function (file) {
                                      return function (param) {
                                        return processFile(client, file);
                                      };
                                    })), (function (param) {
                                return $$Promise.resolve(undefined);
                              }));
                }
                LogError.log(result._0);
                return $$Promise.resolve(undefined);
              }));
}

exports.make = make;
exports.terminate = terminate;
exports.processFile = processFile;
exports.build = build;
/* TTY Not a pure module */
